<%args>
$Update => 0,
$PreferredKey => undef,
</%args>
<%init>
my @results = ();
my $UserObj = $session{'CurrentUser'}->UserObj;
my $preferences = $UserObj->Preferences( $RT::System );

my $default_dashboard_id = 8;
#my $default_dashboard_id = $UserObj->Preferences( DefaultDashboard => 0 );
#warn "XXX default_dashboard_id: $default_dashboard_id";
#use Data::Printer;
#p($UserObj->Preferences);

if (defined($PreferredKey) and (not $UserObj->FirstAttribute('PreferredKey')
        or $PreferredKey ne $UserObj->FirstAttribute('PreferredKey')->Content)) {
    my ($code, $msg) = $UserObj->SetAttribute(Name => 'PreferredKey', Content => $PreferredKey);
    push @results, loc('Preferred Key: [_1]', $msg) unless $code;
}

if ( $Update ) {
    $preferences ||= {};
    $m->comp( '/Widgets/BulkProcess',
        Meta => { map { $_ => RT->Config->Meta($_) } RT->Config->Options },
        Store => $preferences,
        Types => [RT->Config->Options],
        Default => 1,
        Arguments => \%ARGS,
        DefaultValue => { map { $_ => RT->Config->Get($_) } RT->Config->Options },
    );

    my ($ok, $msg) = $UserObj->SetPreferences( $RT::System, $preferences );
    push @results, $ok ? loc("Mail preferences saved.") : $msg;

    if ( $ARGS{DefaultDashboard} ) {
        ( $ok, $msg ) = $UserObj->SetAttribute( Name => 'Pref-DefaultDashboard', Description => 'Default Dashboard', Content => $ARGS{DefaultDashboard} );
        push @results, $ok ? loc('Homepage preferences saved.') : $msg;
        #MaybeRedirectForResults( Actions => \@results, Path => "/Admin/Global/MyRT.html" );
    }

    $m->print( join '\n', @results);
    $m->abort();
}
</%init>
<script>
jQuery(document).ready(function() {
    jQuery('#saveInitialPrefs').click(function(e) {
        e.preventDefault()
        jQuery.post( RT.Config.WebHomePath + '/Helpers/InitialPrefs', jQuery('form#initialPrefsForm').serialize(), function(data, status) {
            if (status == "success") {
                console.log('Preferences saved. Loading video...')
                jQuery.get(RT.Config.WebHomePath + "/Helpers/VideoOverlay", function(data) { showModal(data, true) })
            } else {
                console.error("Error saving initial preferences", status)
            }
        } )
    })
})
</script>
<div class="modal-dialog modal-dialog-centered" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><&|/l&>Welcome to Vurious</&></h5>
      <!--
      <a href="javascript:void(0)" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </a>
      -->
    </div>
    <div class="modal-body">
        <p>Since this appears to be your first time accessing Vurious, please take a moment to help us better customize the experience for you.</p>
        <form method="post" action="/Helpers/InitialPrefs" name="initialPrefsForm" id="initialPrefsForm">
            <input type="text" hidden="hidden" name="Update" value="1" />
            <&|/Widgets/TitleBox, title => loc( 'Preferences' ) &>
% my $option = 'EmailFrequency';  # 'DashboardEmailLanguage'
% my $meta = RT->Config->Meta( $option );
                <& $meta->{'Widget'},
                    Default      => 1,
                    %{ $m->comp('/Widgets/FinalizeWidgetArguments', WidgetArguments => $meta->{'WidgetArguments'} ) },
                    Name         => $option,
                    DefaultValue => scalar RT->Config->Get( $option ),
                    CurrentValue => $preferences->{ $option },
                &>
% $option = 'NotifyActor';  # 'SavedSearchHomePage'
% $meta = RT->Config->Meta( $option );
                <& $meta->{'Widget'},
                    Default      => 1,
                    %{ $m->comp('/Widgets/FinalizeWidgetArguments', WidgetArguments => $meta->{'WidgetArguments'} ) },
                    Name         => $option,
                    DefaultValue => scalar RT->Config->Get( $option ),
                    CurrentValue => $preferences->{ $option },
                &>
                <div class="widget form-row">
                    <div class="label col-3">Homepage</div>
                    <div class="value col-9">
                        <& /Elements/SelectDashboard, Dashboards => [ GetDashboards() ], Default => $default_dashboard_id, ShowEmpty => 0 &>
                    </div>
                </div>
            </&>

            <div class="form-row">
                <div class="col-12">
%#                    <& /Elements/Submit, Name => 'Update', Label => loc('Next') &>
                    <div class="submit">
                        <div class="buttons">
                            <div class="next">
                                <button id="saveInitialPrefs" type="button"><% loc('Next') %></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
  </div>
</div>
% $m->abort;
